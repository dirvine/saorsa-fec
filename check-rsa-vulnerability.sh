#!/bin/bash

echo "=== RSA Vulnerability Check Script ==="
echo ""

# Check current directory
echo "1. Checking saorsa-fec project..."
echo "   Current directory: $(pwd)"
echo ""

# Clean and rebuild
echo "2. Cleaning and rebuilding..."
cargo clean > /dev/null 2>&1
cargo build > /dev/null 2>&1
echo ""

# Run audit
echo "3. Running cargo audit..."
cargo audit --deny warnings 2>&1 | tee /tmp/audit-result.txt
AUDIT_EXIT=$?
echo ""

# Check for rsa in dependency tree
echo "4. Searching for 'rsa' crate in dependency tree..."
if cargo tree 2>&1 | grep -i "rsa v"; then
    echo "   Found RSA crate!"
    cargo tree -i rsa 2>&1 || echo "   Could not invert tree for rsa"
else
    echo "   No RSA crate found in dependencies"
fi
echo ""

# Check Cargo.lock
echo "5. Checking Cargo.lock for rsa..."
if grep -q '"name" = "rsa"' Cargo.lock 2>/dev/null; then
    echo "   Found RSA in Cargo.lock:"
    grep -A5 '"name" = "rsa"' Cargo.lock
else
    echo "   No RSA crate in Cargo.lock"
fi
echo ""

# Check all features
echo "6. Checking with all features enabled..."
cargo tree --all-features 2>&1 | grep -i "rsa v" || echo "   No RSA with all features"
echo ""

# Check dev dependencies
echo "7. Checking dev dependencies..."
cargo tree --all-targets 2>&1 | grep -i "rsa v" || echo "   No RSA in dev dependencies"
echo ""

# Test in isolated environment
echo "8. Testing published crate in isolation..."
TEMP_DIR=$(mktemp -d)
cd "$TEMP_DIR"
cargo init test_project --quiet
echo 'saorsa-fec = "0.4.1"' >> Cargo.toml
cargo tree 2>&1 | grep -i "rsa v" || echo "   No RSA in published crate"
cargo audit 2>&1 | grep -E "(rsa|vulnerability)" || echo "   No vulnerabilities in published crate"
cd - > /dev/null
rm -rf "$TEMP_DIR"
echo ""

# Summary
echo "=== Summary ==="
if [ $AUDIT_EXIT -eq 0 ]; then
    echo "✅ No vulnerabilities found by cargo audit"
else
    echo "❌ Cargo audit found issues (see above)"
fi

if grep -q "rsa v" /tmp/audit-result.txt 2>/dev/null; then
    echo "⚠️  RSA mentioned in audit results"
fi

echo ""
echo "If you're seeing RSA vulnerability elsewhere, please check:"
echo "1. You're in the saorsa-fec directory"
echo "2. Your cargo-audit is up to date: cargo install cargo-audit --force"
echo "3. No workspace Cargo.toml is overriding dependencies"
echo "4. Your Cargo.lock is up to date: cargo update"